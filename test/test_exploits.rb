#!/usr/bin/env ruby

require 'sandbox'
require 'test/unit'

class TestExploits < Test::Unit::TestCase
  def setup
    @s = Sandbox.new
  end

  def eval str
    @s.eval str
  end

  def test_fork
    assert_equal :fork, eval("begin; Kernel.fork; rescue NameError; :fork; end"),
      "DANGEROUS EXPLOIT: Kernel#fork available in the sandbox."
    assert_equal :fork, eval("begin; fork; rescue NameError; :fork; end"),
      "DANGEROUS EXPLOIT: Kernel#fork available in the sandbox."
  end

  def test_io
    assert_equal :NameError, eval("begin; File.open('/etc/passwd'); rescue NameError; :NameError; end"),
      "DANGEROUS EXPLOIT: Filesystem can be accessed!"
  end

  def test_globals
    assert !eval("$0.class.ancestors.last.respond_to?(:p)"),
      "KNOWN EXPLOIT: Kernel can be reached through the globals."
  end
end
